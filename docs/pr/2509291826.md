### PR: Step 1 — PartyIdentifiers

#### Summary

Move Tax ID and other identifiers off `parties` into `party_identifiers` with proper encryption, search, masking, validation, and UI.

#### Key Changes

* **DB**

  * Added `party_identifiers` table with: `party_id`, `identifier_type_id`, `id_type_code` (temporary/back-compat), `value` (encrypted), `value_bidx` (blind index), `value_masked`, `country_code`, `issuing_authority`, `issued_on`, `expires_on`, `is_primary`, timestamps.
  * Unique index: `idx_unique_identifier_value` on `(id_type_code, value_bidx)`.
  * Added ref table `ref_identifier_types` with `code`, `name`, `sort_order`, flags: `require_issuer_country`, `require_issuer_region`, `mask_rule`.
  * Backfill migration from `parties.tax_id*` to `party_identifiers` (SSN/EIN by party type).
  * Guardrails migration to prevent dupes and keep indexes consistent.
  * Drop legacy columns from `parties`: `tax_id`, `tax_id_bidx`, `tax_id_masked`.

* **Models**

  * `Party::Identifier`:

    * `belongs_to :party`, `belongs_to :identifier_type`.
    * `encrypts :value, deterministic: true`; `blind_index :value` with per-type normalization.
    * Normalization covers SSN/ITIN/EIN/foreign_TIN, LEI, passport, DL.
    * Masking via `mask_rule` (e.g., SSN `***-**-####`, EIN `##-******`, generic last4).
    * Validations: presence, single primary per type per party, global de-dup (by `id_type_code + value_bidx`).
    * Scopes: `.primary`, `.tax_ids` (joins type).
  * `Party::Party`

    * `has_many :identifiers`.
    * Helper: `primary_tax_id`.
    * Hard guards for legacy setters: `tax_id=`, `tax_id_bidx=`, `tax_id_masked=` raise.

* **Controllers**

  * `Party::PartiesController`

    * Strong params for `identifiers_attributes`: `:id, :identifier_type_id, :value, :country_code, :issuing_authority, :issued_on, :expires_on, :is_primary, :_destroy`.
    * “Add row” flow preserves open section (`@open_sections`) and builds default identifier (SSN/EIN) based on party type.
    * Rescues DB unique errors and maps to user-facing error on identifier value.

* **Views / UX**

  * **Show**

    * Identifiers list shows friendly type name, primary badge, masked value, per-row Reveal.
  * **Form**

    * Identity first, then Person/Organization, then Identifiers, then Communications.
    * Identifiers extracted to partial `party/identifiers/_fields.html.erb`:

      * Type select from `Ref::IdentifierType`.
      * “Current” masked display.
      * “Change” toggles new value field.
      * “Details” toggles country/region/date fields.
      * Remove = hidden `_destroy` + red Remove button (parent-nested list). Standalone modal uses `DELETE`.
    * Country/Region dropdowns wired via `region-select` controller.
    * “Add …” buttons inside `<summary>` use `event.stopPropagation()` to avoid collapsing; server echoes `@open_sections` to keep panel open.

* **Stimulus**

  * `party_type_controller` broadcasts `party:type-changed`; identifier rows auto-switch SSN/EIN on type change.
  * `identifier_row` controls dynamic visibility, change/details toggles, and issuer requirements.
  * `reveal_controller` supports per-identifier reveal with spinner.
  * `region_select_controller` populates regions by country.

* **Security/PII**

  * Encrypted at rest. Deterministic encryption for equality.
  * Blind index for lookups. No raw values rendered except via explicit “Reveal” action.
  * Reveal endpoint sets `Cache-Control: no-store`.

* **Error Handling**

  * Duplicate ID → friendly validation error “Identifier is already in use by another profile.”
  * Length guard for `value_bidx` ensured by proper binary column length.
  * Legacy writes blocked by model guard methods.

#### Migrations to Run

1. `CreatePartyIdentifiers`
2. `BackfillPartyIdentifiers`
3. `IdentifiersGuardrails` (indexes/constraints)
4. `CreateRefIdentifierTypes` + seed base rows (ssn, itin, ein, foreign_tin, passport, dl, lei).
5. `DropLegacyTaxIdFromParties`

#### How to Test

* Create person and org. Ensure default SSN/EIN row appears. Save without changing value.
* Set SSN/EIN, verify masked display and Reveal returns full value.
* Change to a new value, save, then change back to original; should pass and not create duplicates.
* Add Passport with country/region required toggles.
* Remove an identifier row via button and save; row deleted.
* Search and index pages still work; no legacy tax_id usage.
* Attempt to submit duplicate identifier from a different party; see friendly error.

#### Rollback

* `rails db:rollback` to before drop migration.
* Model still guards legacy setters; if needed, temporarily remove guards and re-add columns (down migration provides them).

#### Follow-ups (future steps)

* Step 2+: Customer profile layer (risk/KYC summaries).
* Step 3+: Relationships model.
* Step 7: PartyDocuments and linking identifiers to uploaded docs.
* Add admin to manage `Ref::IdentifierType` list.
* Add background job to normalize any legacy seed data.

#### Notes for Reviewers

* Focus on migrations order and seed for `ref_identifier_types`.
* Confirm controller error mapping for `ActiveRecord::RecordNotUnique`.
* Confirm Stimulus controllers compiled and loaded; verify no console errors.
* Linting: new ERB partials comply; some legacy views excluded from aggressive autocorrect.
