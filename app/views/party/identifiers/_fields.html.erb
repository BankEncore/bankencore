<%# app/views/party/identifiers/_fields.html.erb %>
<li
  class="grid gap-3 md:grid-cols-[14rem_1fr_auto]"
  data-controller="identifier-row region-select"
  data-region-select-url-value="<%= ref_regions_path(format: :json) %>"
  data-region-select-current-region-value="<%= f.object.issuing_authority %>">

  <%= f.hidden_field :id %>

  <!-- Col 1: Type -->
  <div class="shrink-0 w-[14rem]">
    <label class="label-text mb-1 block">Type</label>
    <select
      name="party_party[identifiers_attributes][<%= f.index %>][id_type_code]"
      id="party_party_identifiers_attributes_<%= f.index %>_id_type_code"
      class="select select-bordered w-full"
      data-identifier-row-target="typeSelect"
      data-action="change->identifier-row#changeType">
      <% identifier_types.each do |t| %>
        <option value="<%= t.code %>"
                data-code="<%= t.code %>"
                data-require-issuer-country="<%= t.require_issuer_country %>"
                data-require-issuer-region="<%= t.require_issuer_region %>"
                <%= "selected" if t.code == f.object.id_type_code %>>
          <%= t.name %>
        </option>
      <% end %>
    </select>
  </div>

  <!-- Col 2: Current -->
  <div class="min-w-0">
    <label class="label-text mb-1 block">Current</label>
    <div class="font-mono truncate" data-identifier-row-target="current">
      <%= f.object.value_masked.presence || "â€”" %>
    </div>
  </div>

  <!-- Col 3: Actions -->
  <div class="justify-self-end shrink-0 flex items-center gap-2 pt-6">
    <button class="btn btn-xs btn-outline"
            data-action="identifier-row#toggleChange"
            data-identifier-row-target="changeBtn">
      Change
    </button>
    <button class="btn btn-xs btn-ghost"
            data-action="identifier-row#toggleDetails">
      Details
    </button>
    <%= f.hidden_field :_destroy, value: "0", data: { role: "destroy-flag" } %>
    <button type="button" class="btn btn-xs btn-error btn-soft"
            onclick="
              const li   = this.closest('li');
              const flag = li.querySelector('input[data-role=&quot;destroy-flag&quot;]');
              if (flag) flag.value = '1';
              // disable inputs but keep :id and :_destroy
              li.querySelectorAll('input,select,textarea').forEach(el => {
                if (!el.name?.match(/\[_destroy\]$/) && !el.name?.match(/\[id\]$/)) el.disabled = true;
              });
              // visually hide instead of removing from DOM
              li.classList.add('hidden');
              return false;">
      Remove
    </button>
  </div>

  <!-- Full width: New value -->
  <div class="mt-3 hidden md:col-span-3" data-identifier-row-target="valueInput">
    <label class="label-text mb-1 block">New value</label>
    <%= f.password_field :value,
          autocomplete: "off",
          class: "input input-bordered w-full",
          placeholder: "Enter new value or leave blank" %>
    <% if f.object.errors[:value].present? %>
      <p class="text-error text-xs mt-1"><%= f.object.errors[:value].join(", ") %></p>
    <% end %>
  </div>

  <!-- Full width: Details -->
  <div class="mt-3 grid md:grid-cols-4 gap-3 hidden md:col-span-3" data-identifier-row-target="details">

    <!-- Issuer country (wrap) -->
    <div class="field" data-identifier-row-target="countryWrap">
      <label class="label-text mb-1 block">Issuer country</label>
      <%= f.collection_select :country_code, countries, :code, :name,
            { include_blank: true },
            { class: "select select-bordered w-full",
              data: { identifier_row_target: "issuerCountry", region_select_target: "country" },
              autocomplete: "country",
              'data-action': 'change->region-select#refresh' } %>
    </div>

    <!-- Issuer region (wrap) -->
    <div class="field" data-identifier-row-target="regionWrap">
      <label class="label-text mb-1 block">Issuer region</label>
      <%= f.select :issuing_authority,
            options_for_select(regions_for(f.object.country_code), f.object.issuing_authority),
            { include_blank: true },
            { class: "select select-bordered w-full",
              data: { identifier_row_target: "issuerRegion", region_select_target: "region", selected: f.object.issuing_authority },
              autocomplete: "address-level1",
              disabled: f.object.country_code.blank? } %>
    </div>

    <div>
      <label class="label-text mb-1 block">Issued on</label>
      <%= f.date_field :issued_on, class: "input input-bordered w-full" %>
    </div>

    <div>
      <label class="label-text mb-1 block">Expires on</label>
      <%= f.date_field :expires_on, class: "input input-bordered w-full" %>
    </div>
  </div>
</li>
