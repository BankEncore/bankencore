<%# app/views/party/identifiers/_fields.html.erb
  Expects locals:
    - f: form builder for a single Party::Identifier (e.g., fields_for :identifiers do |idf|; render ... f: idf)
    - identifier_types: @identifier_types (Ref::IdentifierType collection)
    - countries: @countries (Ref::Country collection)
%>

  <li class="grid grid-cols-1 md:grid-cols-2 gap-4"
      data-controller="region-select"
      data-region-select-url-value="<%= ref_regions_path(format: :json) %>"
      data-region-select-current-region-value="<%= @address&.region_code %>">

  <%= f.hidden_field :id %>

  <div class="grid md:grid-cols-[1fr_auto] gap-3 items-center">
    <div class="flex items-center gap-3 min-w-0">
      <div class="min-w-[12rem]">
        <label class="label-text mb-1 block">Type</label>
        <select name="party_party[identifiers_attributes][<%= f.index %>][identifier_type_id]"
                id="party_party_identifiers_attributes_<%= f.index %>_identifier_type_id"
                class="select select-bordered w-full"
                data-identifier-row-target="typeSelect"
                data-action="change->identifier-row#changeType">
          <% identifier_types.each do |t| %>
            <option value="<%= t.id %>"
                    data-code="<%= t.code %>"
                    data-require-issuer-country="<%= t.require_issuer_country %>"
                    data-require-issuer-region="<%= t.require_issuer_region %>"
                    <%= "selected" if t.id == f.object.identifier_type_id %>>
              <%= t.name %>
            </option>
          <% end %>
        </select>
      </div>

      <div class="flex-1 min-w-0">
        <label class="label-text mb-1 block">Current</label>
        <div class="font-mono truncate" data-identifier-row-target="current">
          <%= f.object.value_masked.presence || "â€”" %>
        </div>
      </div>

      <div class="flex items-center gap-3">
        <label class="label cursor-pointer gap-2">
          <%= f.check_box :is_primary, class: "checkbox" %><span class="label-text">Primary</span>
        </label>
      </div>
    </div>

    <div class="flex items-center gap-2 justify-self-end">
      <button class="btn btn-xs btn-outline"
              data-action="identifier-row#toggleChange"
              data-identifier-row-target="changeBtn">
        Change
      </button>
      <button class="btn btn-xs btn-ghost"
              data-action="identifier-row#toggleDetails">
        Details
      </button>

      <%= f.hidden_field :_destroy, value: "0", data: { role: "destroy-flag" } %>
      <button class="btn btn-xs btn-error btn-soft"
              onclick="
                const li = this.closest('li');
                const flag = li.querySelector('input[data-role=&quot;destroy-flag&quot;]');
                if (flag) flag.value = '1';
                li.remove();
                return false;">
        Remove
      </button>
    </div>
  </div>

  <div class="mt-3 hidden" data-identifier-row-target="valueInput">
    <label class="label-text mb-1 block">New value</label>
    <%= f.password_field :value, autocomplete: "off",
          class: "input input-bordered w-full",
          placeholder: "Enter new value or leave blank" %>
    <% if f.object.errors[:value].present? %>
      <p class="text-error text-xs mt-1"><%= f.object.errors[:value].join(", ") %></p>
    <% end %>
  </div>

  <div class="mt-3 grid md:grid-cols-4 gap-3 hidden" data-identifier-row-target="details">
    <div class="field">
      <label class="label-text mb-1 block">Issuer country</label>
      <%= f.collection_select :country_code, countries, :code, :name,
            { include_blank: true },
            { class: "select select-bordered w-full",
              data: { identifier_row_target: "issuerCountry", region_select_target: "country" },
              autocomplete: "country",
              'data-action': 'change->region-select#refresh' } %>
    </div>

    <div class="field">
      <label class="label-text mb-1 block">Issuer region</label>
      <%= f.select :issuing_authority,
            options_for_select(regions_for(f.object.country_code), f.object.issuing_authority),
            { include_blank: true },
            { class: "select select-bordered w-full",
              data: { identifier_row_target: "issuerRegion", region_select_target: "region", selected: f.object.issuing_authority },
              autocomplete: "address-level1",
              disabled: f.object.country_code.blank? } %>
    </div>

    <div>
      <label class="label-text mb-1 block">Issued on</label>
      <%= f.date_field :issued_on, class: "input input-bordered w-full" %>
    </div>

    <div>
      <label class="label-text mb-1 block">Expires on</label>
      <%= f.date_field :expires_on, class: "input input-bordered w-full" %>
    </div>
  </div>
</li>