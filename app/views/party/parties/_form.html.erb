<%= form_with model: [:party, party],
              scope: :party,
              url: party.persisted? ? party_party_path(party.public_id) : party_parties_path,
              class: "space-y-6" do |f| %>
  
  <% if party.errors.any? %>
  <div class="alert alert-error">
    <b><%= pluralize(party.errors.count, "error") %> prevented saving:</b>
    <ul class="mt-2 list-disc list-inside">
      <% party.errors.full_messages.each do |m| %>
        <li><%= m %></li>
      <% end %>
    </ul>
  </div>
  <% end %>

  <!-- Core -->
  <div class="card bg-base-100 shadow" data-controller="party-type">
    <div class="card-body grid md:grid-cols-2 gap-4">
      <div>
        <label class="label"><span class="label-text">Type</span></label>
        <%= f.select :party_type, [["Person","person"],["Organization","organization"]],
              {}, class: "select select-bordered w-full",
              data: { "party-type-target": "select", action: "change->party-type#change" } %>
      </div>
      <div>
        <label class="label"><span class="label-text">Tax ID</span></label>
        <p class="text-sm opacity-70 mb-2">Current: <%= @party.tax_id_masked || "[not set]" %></p>
        <%= f.password_field :tax_id,
              placeholder: "Enter to change (leave blank to keep)",
              class: "input input-bordered w-full",
              value: nil,
              autocomplete: "off",
              autocapitalize: "off",
              pattern: "\\d*",
              data: { action: "focus->toggle-input#enable", "toggle-input-target": "field" },
              spellcheck: "false" %>
      </div>
    </div>

    <!-- Subprofiles -->
    <div class="card-body grid md:grid-cols-2 gap-6">
      <!-- Person -->
      <div data-party-type-target="personSection">
        <h2 class="card-title mb-2">Person</h2>
        <%= f.fields_for :person do |pf| %>
          <%= pf.hidden_field :_destroy, value: "0", data: { "party-type-target": "personDestroy" } %>
          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label class="label"><span class="label-text">First name</span></label>
              <%= pf.text_field :first_name, class: "input input-bordered w-full" %>
            </div>
            <div>
              <label class="label"><span class="label-text">Last name</span></label>
              <%= pf.text_field :last_name, class: "input input-bordered w-full" %>
            </div>
            <div class="md:col-span-2">
              <label class="label"><span class="label-text">Date of birth</span></label>
              <%= pf.date_field :date_of_birth, class: "input input-bordered w-full" %>
            </div>
          </div>
        <% end %>
      </div>

      <!-- Organization -->
      <div data-party-type-target="orgSection">
        <h2 class="card-title mb-2">Organization</h2>
        <%= f.fields_for :organization do |of| %>
          <%= of.hidden_field :_destroy, value: "1", data: { "party-type-target": "orgDestroy" } %>
          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label class="label"><span class="label-text">Legal name</span></label>
              <%= of.text_field :legal_name, class: "input input-bordered w-full" %>
            </div>
            <div>
              <label class="label"><span class="label-text">Type</span></label>
              <%= of.collection_select :organization_type_code,
                    @org_types, :code, :name,
                    { include_blank: "Select organization type" },
                    class: "select select-bordered w-full" %>
            </div>
            <div class="md:col-span-2">
              <label class="label"><span class="label-text">Formation date</span></label>
              <%= of.date_field :formation_date, class: "input input-bordered w-full" %>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Addresses -->
  <div class="card bg-base-100 shadow" data-controller="nested-form">
    <div class="card-body space-y-4">
      <div class="flex items-center justify-between">
        <h2 class="card-title">Addresses</h2>
        <button class="btn btn-sm" data-action="nested-form#add" type="button">Add address</button>
      </div>

      <div data-nested-form-target="container">
        <%= f.fields_for :addresses do |af| %>
          <%= render "address_fields", f: af %>
        <% end %>
      </div>

      <!-- Template for new rows -->
      <template data-nested-form-target="template">
        <%= f.fields_for :addresses, Party::Address.new(country_code: "US"), child_index: "NEW_RECORD" do |af| %>
          <%= render "address_fields", f: af %>
        <% end %>
      </template>
    </div>
  </div>

  <div class="flex gap-2">
    <%= f.submit (party.persisted? ? "Update" : "Create"), class: "btn btn-primary" %>
    <%= link_to "Cancel", (party.persisted? ? party_party_path(party.public_id) : party_parties_path), class: "btn" %>
  </div>
<% end %>
