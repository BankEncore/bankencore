<div class="mx-auto max-w-3xl">
<%= form_with model: @party,
      scope: :party_party,
      url: (@party.persisted? ? party_party_path(@party.public_id) : party_parties_path),
      data: { turbo: false },
      class: "space-y-6 relative overflow-visible" do |f| %>

  <%# ---- Error summary ---- %>
  <% if @party.errors.any? ||
        @party.person&.errors&.any? || @party.organization&.errors&.any? ||
        @party.addresses.any? { |a| a.errors.any? } ||
        @party.phones.any?   { |p| p.errors.any? } ||
        @party.emails.any?   { |e| e.errors.any? } %>
    <div class="alert alert-error">
      <div class="font-semibold">Please fix the errors below.</div>
      <ul class="mt-2 list-disc list-inside text-sm">
        <% @party.errors.full_messages.each { |m| %><li><%= m %></li><% } %>
        <% if @party.person %><% @party.person.errors.full_messages.each { |m| %><li>Person: <%= m %></li><% } %><% end %>
        <% if @party.organization %><% @party.organization.errors.full_messages.each { |m| %><li>Organization: <%= m %></li><% } %><% end %>
        <% @party.addresses.each_with_index { |a,i| a.errors.full_messages.each { |m| %><li>Address <%= i+1 %>: <%= m %></li><% } } %>
        <% @party.phones.each_with_index   { |p,i| p.errors.full_messages.each { |m| %><li>Phone <%= i+1 %>: <%= m %></li><% } } %>
        <% @party.emails.each_with_index   { |e,i| e.errors.full_messages.each { |m| %><li>Email <%= i+1 %>: <%= m %></li><% } } %>
      </ul>
    </div>
  <% end %>

  <%# ================= Identity ================= %>
  <div class="card bg-base-100 shadow overflow-visible">
    <div class="card-body overflow-visible">
      <div class="grid grid-cols-12 gap-4" data-controller="party-type">
        <h2 class="col-span-12 text-sm font-semibold tracking-wide uppercase text-base-content/70">Identity</h2>

        <div class="col-span-12 md:col-span-6">
          <label class="label-text mb-1 block">Party type</label>
          <%= f.select :party_type,
                options_for_select([["Person","person"],["Organization","organization"]], @party.party_type),
                {},
                class: "select select-bordered w-full",
                data: { party_type_target: "select", action: "change->party-type#change" } %>
        </div>

        <%# -------- Person -------- %>
        <fieldset class="col-span-12 <%= @party.party_type=='organization' ? 'hidden' : '' %>"
                  data-party-type-target="personSection">
          <h3 class="text-sm font-semibold tracking-wide uppercase text-base-content/70 mb-2">Person</h3>
          <%= f.fields_for :person do |pf| %>
            <%= pf.hidden_field :_destroy,
                  value: (@party.party_type=='person' ? "0" : "1"),
                  data: { party_type_target: "personDestroy" } %>
            <div class="grid grid-cols-12 gap-4">
              <div class="col-span-12 md:col-span-3">
                <label class="label-text mb-1 block">Title</label>
                <%= pf.text_field :courtesy_title, class:"input input-bordered w-full", autocapitalize:"words" %>
              </div>
              <div class="col-span-12 md:col-span-3">
                <label class="label-text mb-1 block">First name</label>
                <%= pf.text_field :first_name, class:"input input-bordered w-full", autocomplete:"given-name", autocapitalize:"words" %>
              </div>
              <div class="col-span-12 md:col-span-3">
                <label class="label-text mb-1 block">Middle</label>
                <%= pf.text_field :middle_name, class:"input input-bordered w-full", autocomplete:"additional-name", autocapitalize:"words" %>
              </div>
              <div class="col-span-12 md:col-span-3">
                <label class="label-text mb-1 block">Last name</label>
                <%= pf.text_field :last_name, class:"input input-bordered w-full", autocomplete:"family-name", autocapitalize:"words" %>
              </div>
              <div class="col-span-12 md:col-span-3">
                <label class="label-text mb-1 block">Suffix</label>
                <%= pf.text_field :name_suffix, class:"input input-bordered w-full", autocomplete:"honorific-suffix" %>
              </div>
              <div class="col-span-12 md:col-span-3">
                <label class="label-text mb-1 block">Date of birth</label>
                <%= pf.date_field :date_of_birth, class:"input input-bordered w-full", autocomplete:"bday" %>
              </div>
            </div>
          <% end %>
        </fieldset>

        <%# -------- Organization -------- %>
        <fieldset class="col-span-12 <%= @party.party_type=='person' ? 'hidden' : '' %>"
                  data-party-type-target="orgSection">
          <h3 class="text-sm font-semibold tracking-wide uppercase text-base-content/70 mb-2">Organization</h3>
            <%= f.fields_for :organization do |of| %>
              <div class="grid gap-3">
                <div>
                  <label class="label">Entity type</label>
                  <%= of.collection_select :organization_type_code,
                        @org_types, :code, :name,
                        { include_blank: true },
                        class: "select select-bordered w-full" %>
                </div>

                <div>
                  <label class="label">Legal name</label>
                  <%= of.text_field :legal_name, class: "input input-bordered w-full", required: true %>
                </div>

                <div>
                  <label class="label">Operating name (d/b/a)</label>
                  <%= of.text_field :operating_name, class: "input input-bordered w-full" %>
                </div>

                <div>
                  <label class="label">Formation date</label>
                  <%= of.date_field :formation_date, class: "input input-bordered w-full" %>
                </div>
              </div>
            <% end %>
        </fieldset>

        <%# -------- Identifiers -------- %>
        <div class="col-span-12">
          <details class="rounded-box border p-3 open:pt-3">
            <summary class="flex items-center gap-2 cursor-pointer">
              <span class="text-sm font-medium">Identifiers</span>
              <span class="badge"><%= @party.identifiers.size %></span>
              <span class="ml-auto">
                <%= button_tag "Add",
                      name: :add_identifier, value: "1",
                      class: "btn btn-ghost btn-xs",
                      onclick: "event.stopPropagation()" %>
              </span>
            </summary>

            <div class="pt-3">

              <ul role="list" class="space-y-3">
                <%= f.fields_for :identifiers do |idf| %>
                  <%= render "party/identifiers/fields",
                        f: idf,
                        identifier_types: @identifier_types,
                        countries: @countries %>
                <% end %>
              </ul>
              <p class="text-xs opacity-70 mt-2">Encrypted at rest. Leave value blank to keep existing.</p>
            </div>
          </details>
        </div>
      </div>
    </div>
  </div>

  <%# ================= Communications ================= %>
  <div class="card bg-base-100 shadow overflow-visible">
    <div class="card-body overflow-visible">
      <div class="grid grid-cols-12 gap-4">
        <h2 class="col-span-12 text-sm font-semibold tracking-wide uppercase text-base-content/70">Communications</h2>

        <%# Addresses %>
        <details class="col-span-12 rounded-box border p-3 open:pt-3">
          <summary class="flex items-center gap-2 cursor-pointer">
            <span class="text-sm font-medium">Addresses</span>
            <span class="badge"><%= @party.addresses.size %></span>
            <span class="ml-auto">
              <%= button_tag "Add address", name: :add_address, value: "1", class:"btn btn-ghost btn-xs" %>
            </span>
          </summary>

          <div class="pt-3">
            <fieldset data-controller="single-primary">
              <ul role="list" class="space-y-3">
                <%= f.fields_for :addresses do |af| %>
                  <li class="border rounded-box p-3"
                      data-single-primary-target="row"
                      data-controller="region-select"
                      data-region-select-url-value="<%= ref_regions_path(format: :json) %>">
                    <div class="grid grid-cols-[auto,1fr] gap-3 items-start">
                      <div class="pt-6">
                        <%= af.hidden_field :id %>
                        <% aprimary = af.object&.is_primary ? 1 : 0 %>
                        <%= af.hidden_field :is_primary, value: aprimary, data: { single_primary_target: "hidden" } %>
                        <% rid = "#{af.object.object_id}_addr_primary" %>
                        <input id="<%= rid %>" type="radio"
                               data-action="change->single-primary#pick"
                               data-single-primary-target="radio"
                               <%= "checked" if aprimary == 1 %> />
                        <label for="<%= rid %>" class="text-sm">Primary</label>
                      </div>

                      <div class="grid md:grid-cols-12 gap-3 w-full">
                        <div class="md:col-span-3">
                          <label class="label-text mb-1 block">Type</label>
                          <%= af.collection_select :address_type_code, @address_types, :code, :name,
                                { include_blank: true }, { class: "select select-bordered w-full" } %>
                        </div>

                        <div class="md:col-span-9">
                          <label class="label-text mb-1 block">Line 1</label>
                          <%= af.text_field :line1, class:"input input-bordered w-full",
                                placeholder:"Street address", autocomplete:"address-line1" %>
                        </div>

                        <div class="md:col-span-6">
                          <%= af.text_field :line2, placeholder:"Apt, suite, etc. (optional)",
                                class:"input input-bordered w-full", autocomplete:"address-line2" %>
                        </div>

                        <div class="md:col-span-6">
                          <%= af.text_field :line3, placeholder:"Attention / care of (optional)",
                                class:"input input-bordered w-full", autocomplete:"address-line3" %>
                        </div>

                        <div class="md:col-span-4">
                          <label class="label-text mb-1 block">Country</label>
                          <%= af.collection_select :country_code, @countries, :code, :name,
                                { include_blank: true },
                                { class:"select select-bordered w-full",
                                  data: { region_select_target:"country", action:"change->region-select#refresh" },
                                  autocomplete:"country" } %>
                        </div>

                        <div class="md:col-span-4">
                          <label class="label-text mb-1 block">Region/State</label>
                          <%= af.select :region_code,
                                options_for_select(regions_for(af.object.country_code), af.object.region_code),
                                { include_blank: true },
                                { class:"select select-bordered w-full",
                                  data: { region_select_target:"region", selected:af.object.region_code },
                                  autocomplete:"address-level1",
                                  disabled: af.object.country_code.blank? } %>
                        </div>

                        <div class="md:col-span-4">
                          <label class="label-text mb-1 block">City</label>
                          <%= af.text_field :locality, class:"input input-bordered w-full",
                                autocomplete:"address-level2" %>
                        </div>

                        <div class="md:col-span-4">
                          <label class="label-text mb-1 block">Postal</label>
                          <%= af.text_field :postal_code, class:"input input-bordered w-full",
                                inputmode:"numeric", autocomplete:"postal-code" %>
                        </div>

                        <div class="md:col-span-8 flex items-center gap-4 pt-1">
                          <label class="label cursor-pointer gap-2">
                            <%= af.check_box :_destroy, class:"checkbox" %>
                            <span class="label-text">Remove</span>
                          </label>
                        </div>
                      </div>
                    </div>
                  </li>
                <% end %>
              </ul>
            </fieldset>
          </div>
        </details>

        <%# Phones %>
        <details class="col-span-12 rounded-box border p-3 open:pt-3">
          <summary class="flex items-center gap-2 cursor-pointer">
            <span class="text-sm font-medium">Phones</span>
            <span class="badge"><%= @party.phones.size %></span>
            <span class="ml-auto">
              <%= button_tag "Add phone", name: :add_phone, value: "1", class:"btn btn-ghost btn-xs" %>
            </span>
          </summary>

          <div class="pt-3">
            <fieldset data-controller="single-primary">
              <ul role="list" class="space-y-3">
                <%= f.fields_for :phones do |pf| %>
                  <li class="border rounded-box p-3" data-single-primary-target="row">
                    <div class="grid grid-cols-[auto,1fr] gap-3 items-start">
                      <div class="pt-6">
                        <%= pf.hidden_field :id %>
                        <% pprimary = pf.object&.is_primary ? 1 : 0 %>
                        <%= pf.hidden_field :is_primary, value: pprimary, data: { single_primary_target: "hidden" } %>

                        <% rid = "#{pf.object.object_id}_phone_primary" %>
                        <input id="<%= rid %>"
                               type="radio"
                               data-action="change->single-primary#pick"
                               data-single-primary-target="radio"
                               <%= "checked" if pprimary == 1 %> />
                        <label for="<%= rid %>" class="text-sm">Primary</label>
                      </div>

                      <div class="grid md:grid-cols-5 gap-3 w-full items-start">
                        <div>
                          <label class="label-text mb-1 block">Phone type</label>
                          <%= pf.collection_select :phone_type_code, @phone_types, :code, :name,
                                { include_blank: true }, { class: "select select-bordered w-full" } %>
                        </div>

                        <div class="md:col-span-2">
                          <label class="label-text mb-1 block">Phone</label>
                          <%= pf.telephone_field :phone_e164,
                                class: "input input-bordered w-full",
                                placeholder: "+15551234567",
                                inputmode: "tel",
                                autocomplete: "tel" %>
                        </div>

                        <div>
                          <label class="label-text mb-1 block">Ext</label>
                          <%= pf.text_field :phone_ext, class: "input input-bordered w-full", inputmode: "numeric" %>
                        </div>

                        <div class="flex items-center gap-4 pt-6">
                          <label class="label cursor-pointer gap-2">
                            <%= pf.check_box :consent_sms, class: "checkbox" %>
                            <span class="label-text">SMS consent</span>
                          </label>
                        </div>

                        <div class="md:col-span-5 mt-3">
                          <label class="label cursor-pointer gap-2">
                            <%= pf.check_box :_destroy, class: "checkbox" %>
                            <span class="label-text">Remove</span>
                          </label>
                        </div>
                      </div>
                    </div>
                  </li>
                <% end %>
              </ul>
            </fieldset>
          </div>
        </details>

        <%# Emails %>
        <details class="col-span-12 rounded-box border p-3 open:pt-3">
          <summary class="flex items-center gap-2 cursor-pointer">
            <span class="text-sm font-medium">Emails</span>
            <span class="badge"><%= @party.emails.size %></span>
            <span class="ml-auto"><%= button_tag "Add email", name: :add_email, value: "1", class:"btn btn-ghost btn-xs" %></span>
          </summary>

          <div class="pt-3">
            <fieldset data-controller="single-primary">
              <ul role="list" class="space-y-3">
                <%= f.fields_for :emails do |ef| %>
                  <li class="border rounded-box p-3" data-single-primary-target="row">
                    <div class="grid grid-cols-[auto,1fr] gap-3 items-start">
                      <div class="pt-6">
                        <%= ef.hidden_field :id %>
                        <% eprimary = ef.object&.is_primary ? 1 : 0 %>
                        <%= ef.hidden_field :is_primary, value: eprimary, data: { single_primary_target: "hidden" } %>
                        <% rid = "#{ef.object.object_id}_email_primary" %>
                        <input id="<%= rid %>" type="radio"
                               aria-label="Make primary"
                               data-action="change->single-primary#pick"
                               data-single-primary-target="radio"
                               <%= "checked" if eprimary == 1 %> />
                        <label for="<%= rid %>" class="text-sm">Primary</label>
                      </div>

                      <div class="grid grid-cols-12 gap-2 items-center w-full">
                        <div class="col-span-5">
                          <%= ef.email_field :email, class: "input input-sm w-full" %>
                        </div>

                        <div class="col-span-3">
                          <%= ef.select :email_type_code,
                                options_from_collection_for_select(@email_types, :code, :name, ef.object.email_type_code),
                                {}, class: "select input-sm w-full" %>
                        </div>

                        <div class="col-span-4 text-right">
                          <%= ef.hidden_field :_destroy %>
                          <button type="button" class="btn btn-ghost btn-sm" data-action="click->nested#remove">Remove</button>
                        </div>
                      </div>
                    </div>
                  </li>
                <% end %>
              </ul>
            </fieldset>
          </div>
        </details>

      </div>
    </div>
  </div>

  <%# ================= Actions (sticky, inside form but outside cards) ================= %>
  <div class="sticky bottom-0 inset-x-0 z-50 bg-base-100/95 backdrop-blur border-t">
    <div class="mx-auto max-w-3xl px-4 py-3 flex items-center justify-end gap-2">
      <%= link_to "Cancel",
            (@party.persisted? ? party_party_path(@party.public_id) : party_parties_path),
            class:"btn btn-ghost" %>
      <%= f.submit(@party.persisted? ? "Update" : "Create",
            class:"btn btn-primary",
            data: { disable_with: "Savingâ€¦" }) %>
    </div>
  </div>

<% end %>
</div>
