<%# app/views/party/parties/_form.html.erb â€” DROP-IN CLEAN %>
<%= form_with model: @party,
      scope: :party_party,
      url: (@party.persisted? ? party_party_path(@party.public_id) : party_parties_path),
      data: { turbo: false },
      class: "space-y-6" do |f| %>

  <% if @party.errors.any? ||
        @party.person&.errors&.any? || @party.organization&.errors&.any? ||
        @party.addresses.any? { |a| a.errors.any? } ||
        @party.phones.any?   { |p| p.errors.any? } ||
        @party.emails.any?   { |e| e.errors.any? } %>
    <div class="alert alert-error">
      <div class="font-semibold">Please fix the errors below.</div>
      <ul class="mt-2 list-disc list-inside text-sm">
        <% @party.errors.full_messages.each { |m| %><li><%= m %></li><% } %>
        <% if @party.person %><% @party.person.errors.full_messages.each { |m| %><li>Person: <%= m %></li><% } %><% end %>
        <% if @party.organization %><% @party.organization.errors.full_messages.each { |m| %><li>Organization: <%= m %></li><% } %><% end %>
        <% @party.addresses.each_with_index { |a,i| a.errors.full_messages.each { |m| %><li>Address <%= i+1 %>: <%= m %></li><% } } %>
        <% @party.phones.each_with_index   { |p,i| p.errors.full_messages.each { |m| %><li>Phone <%= i+1 %>: <%= m %></li><% } } %>
        <% @party.emails.each_with_index   { |e,i| e.errors.full_messages.each { |m| %><li>Email <%= i+1 %>: <%= m %></li><% } } %>
      </ul>
    </div>
  <% end %>

  <%# === Identity ========================================================= %>
  <div class="card bg-base-100 shadow">
    <div class="card-body">
      <fieldset class="grid md:grid-cols-2 gap-4" data-controller="party-type">
        <legend class="text-base font-semibold mb-2">Identity</legend>

        <div>
          <label class="label"><span class="label-text">Party type</span></label>
          <%= f.select :party_type,
                options_for_select([["Person","person"],["Organization","organization"]], @party.party_type),
                {},
                class: "select select-bordered w-full max-w-xs",
                data: { party_type_target: "select", action: "change->party-type#change" } %>
        </div>
        
        <div class="md:col-span-2">
          <div class="flex items-center justify-between">
            <label class="label"><span class="label-text">Identifiers</span></label>
            <%= button_tag "Add identifier", name: :add_identifier, value: "1", class: "btn btn-ghost btn-xs" %>
          </div>

          <% # ensure at least one primary tax-id row exists for the current party type %>
          <% if @party.identifiers.tax_ids.where(is_primary: true).blank? %>
            <% @party.identifiers.build(id_type_code: (@party.organization ? "ein" : "ssn"), is_primary: true) %>
          <% end %>

          <ul class="space-y-3">
            <% @party.identifiers.each do |pi| %>
              <li class="border rounded-box p-3">
                <%= f.fields_for :identifiers, pi do |idf| %>
                  <%= idf.hidden_field :id %>

                  <div class="grid md:grid-cols-6 gap-3">
                    <div>
                      <%= idf.label :identifier_type_id, "Type", class: "label-text" %>
                      <%= idf.collection_select :identifier_type_id, @identifier_types, :id, :name, {}, class:"select select-bordered w-full" %>
                    </div>

                    <div class="md:col-span-2">
                      <%= idf.label :value, "Identifier", class: "label-text" %>

                      <%# Show masked current value if persisted %>
                      <% if pi.persisted? && pi.value_masked.present? %>
                        <span class="badge badge-ghost text-xs mb-1">Current: <span class="font-mono ml-1"><%= pi.value_masked %></span></span>
                      <% end %>

                      <%= idf.password_field :value,
                            autocomplete:"off",
                            class:"input input-bordered w-full",
                            placeholder: (pi.persisted? ? "Leave blank to keep" : "Enter value") %>

                      <%# Inline errors %>
                      <% if idf.object.errors[:value].present? %>
                        <p class="text-error text-xs mt-1"><%= idf.object.errors[:value].join(", ") %></p>
                      <% end %>
                    </div>

                    <div>
                      <%= idf.label :country_code, "Issuer country", class:"label-text" %>
                      <%= idf.text_field :country_code, class:"input input-bordered w-full", placeholder:"US" %>
                    </div>
                    <div>
                      <%= idf.label :issuing_authority, "Issuer", class:"label-text" %>
                      <%= idf.text_field :issuing_authority, class:"input input-bordered w-full" %>
                    </div>
                    <div class="md:col-span-2 grid grid-cols-2 gap-3">
                      <div>
                        <%= idf.label :issued_on, class:"label-text" %>
                        <%= idf.date_field :issued_on, class:"input input-bordered w-full" %>
                      </div>
                      <div>
                        <%= idf.label :expires_on, class:"label-text" %>
                        <%= idf.date_field :expires_on, class:"input input-bordered w-full" %>
                      </div>
                    </div>
                  </div>

                  <div class="mt-3 flex items-center gap-4">
                    <label class="label cursor-pointer gap-2">
                      <%= idf.check_box :is_primary, class:"checkbox" %><span class="label-text">Primary</span>
                    </label>
                    <label class="label cursor-pointer gap-2">
                      <%= idf.check_box :_destroy, class:"checkbox" %><span class="label-text">Remove</span>
                    </label>
                  </div>
                <% end %>
              </li>
            <% end %>
          </ul>

          <p class="text-xs opacity-70 mt-2">Encrypted at rest. Leave value blank to keep existing.</p>
        </div>

        </div>

        <fieldset class="<%= @party.party_type=='organization' ? 'hidden' : '' %> md:col-span-2"
                  data-party-type-target="personSection">
          <legend class="text-sm font-semibold uppercase opacity-70 mb-2">Person</legend>
          <%= f.fields_for :person do |pf| %>
            <%= pf.hidden_field :_destroy, value: "0", data: { party_type_target: "personDestroy" } %>
            <div class="grid grid-cols-2 gap-3">
              <div class="col-span-2 md:col-span-1">
                <%= pf.label :courtesy_title, class: "label-text" %>
                <%= pf.text_field :courtesy_title, class: "input input-bordered w-full", autocapitalize: "words" %>
              </div>
              <div>
                <%= pf.label :first_name, class: "label-text" %>
                <%= pf.text_field :first_name, class: "input input-bordered w-full", autocomplete: "given-name", autocapitalize: "words" %>
              </div>
              <div>
                <%= pf.label :middle_name, class: "label-text" %>
                <%= pf.text_field :middle_name, class: "input input-bordered w-full", autocomplete: "additional-name", autocapitalize: "words" %>
              </div>
              <div>
                <%= pf.label :last_name, class: "label-text" %>
                <%= pf.text_field :last_name, class: "input input-bordered w-full", autocomplete: "family-name", autocapitalize: "words" %>
              </div>
              <div>
                <%= pf.label :name_suffix, class: "label-text" %>
                <%= pf.text_field :name_suffix, class: "input input-bordered w-full", autocomplete: "honorific-suffix" %>
              </div>
              <div class="col-span-2 md:col-span-1">
                <%= pf.label :date_of_birth, class: "label-text" %>
                <%= pf.date_field :date_of_birth, class: "input input-bordered w-full", autocomplete: "bday" %>
              </div>
            </div>
          <% end %>
        </fieldset>

        <fieldset class="<%= @party.party_type=='person' ? 'hidden' : '' %> md:col-span-2"
                  data-party-type-target="orgSection">
          <legend class="text-sm font-semibold uppercase opacity-70 mb-2">Organization</legend>
          <%= f.fields_for :organization do |of| %>
            <%= of.hidden_field :_destroy, value: "1", data: { party_type_target: "orgDestroy" } %>
            <div class="grid gap-3">
              <div>
                <%= of.label :legal_name, class: "label-text" %>
                <%= of.text_field :legal_name, class: "input input-bordered w-full", autocapitalize: "words" %>
              </div>
              <div>
                <%= of.label :operating_name, class: "label-text" %>
                <%= of.text_field :operating_name, class: "input input-bordered w-full", autocapitalize: "words" %>
              </div>
              <div class="grid grid-cols-2 gap-3">
                <div>
                  <%= of.label :organization_type_code, "Type", class: "label-text" %>
                  <%= of.text_field :organization_type_code, class: "input input-bordered w-full" %>
                </div>
                <div>
                  <%= of.label :formation_date, class: "label-text" %>
                  <%= of.date_field :formation_date, class: "input input-bordered w-full" %>
                </div>
              </div>
            </div>
          <% end %>
        </fieldset>
      </fieldset>
    </div>
  </div>

  <%# === Addresses ======================================================== %>
  <div class="card bg-base-100 shadow">
    <div class="card-body">
      <fieldset>
        <legend class="card-title text-base">Addresses</legend>
        <div class="flex justify-end mb-2">
          <%= button_tag "Add address", name: :add_address, value: "1", class: "btn btn-ghost btn-xs" %>
        </div>

        <ul role="list" class="space-y-3">
          <% @party.addresses.each do |a| %>
            <li class="border rounded-box p-3"
                data-controller="region-select"
                data-region-select-url-value="<%= ref_regions_path(format: :json) %>">
              <%= f.fields_for :addresses, a do |af| %>
                <div class="grid md:grid-cols-12 gap-3">
                  <div class="md:col-span-3">
                    <%= af.label :address_type_code, "Address type", class: "label-text" %>
                    <%= af.collection_select :address_type_code, @address_types, :code, :name,
                          { include_blank: true }, { class: "select select-bordered w-full" } %>
                  </div>

                  <div class="md:col-span-9">
                    <%= af.label :line1, class: "label-text" %>
                    <%= af.text_field :line1, class: "input input-bordered w-full",
                          placeholder: "Street address", autocomplete: "address-line1" %>
                  </div>

                  <div class="md:col-span-6">
                    <%= af.text_field :line2, placeholder: "Apt, suite, etc. (optional)",
                          class: "input input-bordered w-full", autocomplete: "address-line2" %>
                  </div>
                  <div class="md:col-span-6">
                    <%= af.text_field :line3, placeholder: "Attention / care of (optional)",
                          class: "input input-bordered w-full", autocomplete: "address-line3" %>
                  </div>

                  <div class="md:col-span-4">
                    <%= af.label :country_code, "Country", class: "label-text" %>
                    <%= af.collection_select :country_code, @countries, :code, :name,
                          { include_blank: true },
                          { class: "select select-bordered w-full",
                            data: { region_select_target: "country", action: "change->region-select#refresh" },
                            autocomplete: "country" } %>
                  </div>

                  <div class="md:col-span-4">
                    <%= af.label :region_code, "Region/State", class: "label-text" %>
                    <%= af.select :region_code,
                          options_for_select(regions_for(a.country_code), a.region_code),
                          { include_blank: true },
                          { class: "select select-bordered w-full",
                            data: { region_select_target: "region", selected: a.region_code },
                            autocomplete: "address-level1",
                            disabled: a.country_code.blank? } %>
                  </div>

                  <div class="md:col-span-4">
                    <%= af.label :city, "City", class: "label-text" %>
                    <%= af.text_field :locality, class: "input input-bordered w-full",
                          autocomplete: "address-level2" %>
                  </div>

                  <div class="md:col-span-4">
                    <%= af.label :postal_code, "Postal", class: "label-text" %>
                    <%= af.text_field :postal_code, class: "input input-bordered w-full",
                          inputmode: "numeric", autocomplete: "postal-code" %>
                  </div>

                  <div class="md:col-span-8 flex items-center gap-4 pt-1">
                    <label class="label cursor-pointer gap-2">
                      <%= af.check_box :is_primary, class: "checkbox" %><span class="label-text">Primary</span>
                    </label>
                    <label class="label cursor-pointer gap-2">
                      <%= af.check_box :_destroy, class: "checkbox" %><span class="label-text">Remove</span>
                    </label>
                  </div>
                </div>
              <% end %>
            </li>
          <% end %>
        </ul>
      </fieldset>
    </div>
  </div>

  <%# === Phones =========================================================== %>
  <div class="card bg-base-100 shadow">
    <div class="card-body">
      <fieldset>
        <legend class="card-title text-base">Phones</legend>
        <div class="flex justify-end mb-2">
          <%= button_tag "Add phone", name: :add_phone, value: "1", class: "btn btn-ghost btn-xs" %>
        </div>

        <ul role="list" class="space-y-3">
          <% @party.phones.each do |p| %>
            <li class="border rounded-box p-3">
              <%= f.fields_for :phones, p do |pf| %>
                <div class="grid md:grid-cols-5 gap-3">
                  <div>
                    <%= pf.label :phone_type_code, "Phone type", class: "label-text" %>
                    <%= pf.collection_select :phone_type_code, @phone_types, :code, :name,
                          { include_blank: true }, { class: "select select-bordered w-full" } %>
                  </div>
                  <div class="md:col-span-2">
                    <%= pf.label :phone_e164, "Phone", class: "label-text" %>
                    <%= pf.telephone_field :phone_e164, class: "input input-bordered w-full",
                          placeholder: "+15551234567", inputmode: "tel", autocomplete: "tel" %>
                  </div>
                  <div>
                    <%= pf.label :phone_ext, "Ext", class: "label-text" %>
                    <%= pf.text_field :phone_ext, class: "input input-bordered w-full", inputmode: "numeric" %>
                  </div>
                  <div class="flex items-center gap-4 pt-6">
                    <label class="label cursor-pointer gap-2">
                      <%= pf.check_box :consent_sms, class: "checkbox" %><span class="label-text">SMS consent</span>
                    </label>
                  </div>
                </div>
                <div class="mt-3 flex items-center gap-4">
                  <label class="label cursor-pointer gap-2">
                    <%= pf.check_box :is_primary, class: "checkbox" %><span class="label-text">Primary</span>
                  </label>
                  <label class="label cursor-pointer gap-2">
                    <%= pf.check_box :_destroy, class: "checkbox" %><span class="label-text">Remove</span>
                  </label>
                </div>
              <% end %>
            </li>
          <% end %>
        </ul>
      </fieldset>
    </div>
  </div>

  <%# === Emails =========================================================== %>
  <div class="card bg-base-100 shadow">
    <div class="card-body">
      <fieldset>
        <legend class="card-title text-base">Emails</legend>
        <div class="flex justify-end mb-2">
          <%= button_tag "Add email", name: :add_email, value: "1", class: "btn btn-ghost btn-xs" %>
        </div>

        <ul role="list" class="space-y-3">
          <% @party.emails.each do |e| %>
            <li class="border rounded-box p-3">
              <%= f.fields_for :emails, e do |ef| %>
                <div class="grid md:grid-cols-3 gap-3">
                  <div>
                    <%= ef.label :email_type_code, "Email type", class: "label-text" %>
                    <%= ef.collection_select :email_type_code, @email_types, :code, :name,
                          { include_blank: true }, { class: "select select-bordered w-full" } %>
                  </div>
                  <div class="md:col-span-2">
                    <%= ef.label :email, class: "label-text" %>
                    <%= ef.email_field :email, class: "input input-bordered w-full", autocomplete: "email" %>
                  </div>
                </div>
                <div class="mt-3 flex items-center gap-4">
                  <label class="label cursor-pointer gap-2">
                    <%= ef.check_box :is_primary, class: "checkbox" %><span class="label-text">Primary</span>
                  </label>
                  <label class="label cursor-pointer gap-2">
                    <%= ef.check_box :_destroy, class: "checkbox" %><span class="label-text">Remove</span>
                  </label>
                </div>
              <% end %>
            </li>
          <% end %>
        </ul>
      </fieldset>
    </div>
  </div>

  <%# === Actions ========================================================== %>
  <div class="flex items-center justify-end gap-2">
    <%= link_to "Cancel",
          (@party.persisted? ? party_party_path(@party.public_id) : party_parties_path),
          class: "btn btn-ghost" %>
    <%= f.submit(@party.persisted? ? "Update" : "Create", class: "btn btn-primary") %>
  </div>
<% end %>
