<!-- app/views/party/addresses/_form.html.erb -->
<%= form_with scope: :party_address,
      url: (@address.persisted? ? party_party_address_path(@party.public_id, @address)
                                : party_party_addresses_path(@party.public_id)),
      method: (@address.persisted? ? :patch : :post),
      data: { turbo_frame: "comm_modal_frame" } do |f| %>

  <div class="grid gap-3"
       data-controller="region-select"
       data-region-select-url-value="<%= ref_regions_path(format: :json) %>">

    <!-- Type -->
    <div class="select">
      <%= f.collection_select :address_type_code, @address_types, :code, :name,
            { include_blank: true }, {} %>
    </div>

    <!-- Street 1 -->
    <div class="input">
      <%= f.text_field :line1, required: true, placeholder: "Street 1" %>
    </div>

    <!-- Street 2 -->
    <div class="input">
      <%= f.text_field :line2, placeholder: "Street 2" %>
    </div>

    <!-- Locality (City) -->
    <div class="input">
      <%= f.text_field :locality, required: true, placeholder: "Locality (City)" %>
    </div>

    <!-- Country (default US) -->
    <div class="select">
      <%= f.collection_select :country_code, @countries, :code, :name,
            { include_blank: true },
            { data: { region_select_target: "country", action: "change->region-select#refresh" },
              value: (@address.country_code.presence || "US") } %>
    </div>

    <!-- Region/State (default MI when country is US) -->
    <div class="select">
      <% selected_region = @address.region_code.presence || ("MI" if (@address.country_code.presence || "US") == "US") %>
      <%= f.select :region_code,
            options_for_select(regions_for(@address.country_code.presence || "US"), selected_region),
            { include_blank: true },
            { data: { region_select_target: "region" },
              disabled: (@address.country_code.blank?) } %>
    </div>

    <!-- Postal Code -->
    <div class="input">
      <%= f.text_field :postal_code, placeholder: "Postal Code" %>
    </div>

    <!-- Primary -->
    <label class="flex items-center gap-2">
      <%= f.check_box :is_primary %> Primary
    </label>
  </div>

  <div class="mt-4 flex justify-end gap-2">
    <button type="button" class="btn btn-ghost" data-action="modal#close">Cancel</button>
    <%= f.submit "Save", class: "btn btn-primary" %>
  </div>
<% end %>
