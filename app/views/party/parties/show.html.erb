<%# ===== Page Header Hero ===== %>
<div class="mx-auto max-w-7xl px-4 md:px-6">
  <div class="hero bg-base-200 rounded-lg p-6 mb-6">
    <div class="hero-content w-full p-0">
      <div class="flex w-full items-start justify-between gap-4 flex-nowrap">

        <!-- Left: title + meta -->
        <div class="min-w-0 flex-1">
          <h1 class="text-3xl font-bold truncate"><%= @party.display_name %></h1>
          <div class="mt-2 flex flex-wrap items-center gap-2 text-sm">
            <span class="badge badge-outline"><%= @party.party_type %></span>
            <span class="badge badge-ghost">Updated <%= l(@party.updated_at, format: :short) %></span>
          </div>
        </div>

        <!-- Right: actions -->
        <div class="shrink-0 flex items-center gap-2">
          <%= link_to "Edit", edit_party_party_path(@party.public_id), class: "btn btn-primary btn-sm" %>
          <button class="btn btn-error btn-sm"
                  onclick="document.getElementById('confirm-delete').showModal()">
            Delete
          </button>
          <%= link_to "Back", party_parties_path, class: "btn btn-ghost btn-sm" %>
        </div>

      </div>
    </div>
  </div>
</div>
<%# ===== TWO COLUMNS (sibling of hero) ===== %>
<div class="mx-auto max-w-7xl px-4 md:px-6">
  <div class="flex flex-nowrap items-start gap-6">
    <!-- LEFT column: fixed -->
    <section class="w-80 shrink-0 flex flex-col gap-6 min-w-0">
      <%# Identity Card %>
      <div class="card bg-base-200 shadow-md">
        <div class="card-body">
          <h2 class="card-title text-base font-semibold">Identity</h2>
          <% if @party.customer_number.present? %>
            <div>
              <div class="text-xs opacity-70">Customer #</div>
              <div class="mt-1 flex items-center gap-2">
                <span class="text-lg font-semibold tabular-nums"><%= @party.customer_number %></span>
                <button class="btn btn-ghost btn-xs"
                        data-controller="copy"
                        data-copy-text-value="<%= @party.customer_number %>"
                        data-action="copy#copy">Copy</button>
              </div>
            </div>
            <div class="divider mt-2 mb-0"></div>
          <% end %>

          <dl class="mt-2">
            <% if @party.person %>
              <div class="py-2 grid grid-cols-3 gap-2">
                <dt class="opacity-70">Name</dt>
                <dd class="col-span-2"><%= [@party.person.first_name, @party.person.last_name].join(" ") %></dd>
              </div>
              <% if @party.person.date_of_birth.present? %>
                <div class="py-2 grid grid-cols-3 gap-2">
                  <dt class="opacity-70">DOB</dt>
                  <dd class="col-span-2"><%= @party.person.date_of_birth.to_fs(:mmm_d_yyyy) %></dd>
                </div>
              <% end %>
            <% else %>
              <div class="py-2 grid grid-cols-3 gap-2">
                <dt class="opacity-70">Legal name</dt>
                <dd class="col-span-2"><%= @party.organization.legal_name %></dd>
              </div>
              <% if @party.organization.formation_date.present? %>
                <div class="py-2 grid grid-cols-3 gap-2">
                  <dt class="opacity-70">Formed</dt>
                  <dd class="col-span-2"><%= @party.organization.formation_date.to_fs(:mmm_d_yyyy) %></dd>
                </div>
              <% end %>
            <% end %>
          </dl>
        </div>
      </div>

      <%# Identifiers Card %>
      <div class="card bg-base-200 shadow-md">
        <div class="card-body">
          <h2 class="card-title text-base font-semibold">Identifiers</h2>
          <ul class="divide-y">
          <%= render "party/identifiers/list", party: @party %>
            <% @party.identifiers.each do |idn| %>
              <li class="py-2 flex justify-between text-sm">
                <span class="font-medium"><%= idn.identifier_type&.name || idn.id_type_code %></span>
                <span class="opacity-70"><%= mask_tax_id(idn.value, id_type: idn.id_type_code) %></span>
              </li>
            <% end %>
            <% if @party.identifiers.empty? %>
              <li class="py-2 opacity-60 text-sm">No identifiers.</li>
            <% end %>
          </ul>
        </div>
      </div>

      <%# Relationships %>
      <div class="card bg-base-200 shadow-md">
        <div class="card-body p-6">
          <div class="flex items-center justify-between">
            <h2 class="card-title text-base font-semibold">Relationships</h2>
            <details class="dropdown dropdown-end">
              <summary class="btn btn-outline btn-sm list-none">Add link</summary>
              <div class="dropdown-content z-50 card bg-base-100 shadow-2xl p-4 mt-2 w-[36rem] max-w-[95vw] sm:w-[40rem]">
                <div id="<%= dom_id(@party, :link_form) %>">
                  <%= render "party/links/form", party: @party, ui: :wide %>
                </div>
              </div>
            </details>
          </div>
          <turbo-frame id="<%= dom_id(@party, :links) %>">
            <%= render "party/links/list_by_type",
                  party: @party,
                  links: Party::Link.involving(@party.id).includes(:party_link_type, :source_party, :target_party).order(:party_link_type_code),
                  editable: true, tag_variant: :neutral %>
          </turbo-frame>
        </div>
      </div>

    </section>

    <!-- RIGHT column: flexible -->
    <section class="flex-1 flex flex-col gap-6 min-w-0">
      <%# Contact Information %>
      <div class="card bg-base-200 shadow-md">
        <div class="card-body">
          <h2 class="card-title text-base font-semibold">Contact Information</h2>
          <%= render "party/addresses/list", party: @party %>
          <%= render "party/phones/list",    party: @party %>
          <%= render "party/emails/list",    party: @party %>
        </div>
      </div>

      <%# Groups %>
      <div class="card bg-base-200 shadow-md">
        <div class="card-body">
          <div class="flex items-center justify-between">
            <h2 class="card-title text-base font-semibold">Groups</h2>
            <%= link_to "Join group", new_party_party_group_membership_path(@party.public_id),
                  data: { turbo_frame: "comm_modal_frame" }, class: "btn btn-ghost btn-xs" %>
          </div>
          <%= render "party/groups/section", party: @party %>
        </div>
      </div>

      <%# Screenings %>
      <div class="card bg-base-200 shadow-md">
        <div class="card-body">
          <div class="flex items-center justify-between">
            <h2 class="card-title text-base font-semibold">Screenings</h2>
            <div class="flex items-center gap-2">
              <% if @party.party_risk_score %>
                <% badge = { 0 => "badge-success", 1 => "badge-warning", 2 => "badge-error" }[@party.risk_band] %>
                <div class="badge <%= badge %>">Risk Score: <%= @party.party_risk_score %></div>
              <% end %>
              <%= link_to "New screening", new_party_party_screening_path(@party.public_id), class: "btn btn-primary btn-sm" %>
            </div>
          </div>

          <div class="overflow-x-auto mt-3">
            <table class="table table-zebra">
              <thead>
                <tr><th>When</th><th>Kind</th><th>Status</th><th>Score</th><th></th></tr>
              </thead>
              <tbody>
                <% @party.screenings.order(created_at: :desc).limit(5).each do |s| %>
                  <% status_badge = case s.status
                    when "completed" then "badge-success"
                    when "pending"    then "badge-warning"
                    else "badge-ghost" end %>
                  <tr>
                    <td><%= s.completed_at&.to_fs(:short) || s.requested_at&.to_fs(:short) %></td>
                    <td><%= s.kind.humanize %></td>
                    <td><span class="badge <%= status_badge %>"><%= s.status.humanize %></span></td>
                    <td><%= s.normalized_score || "N/A" %></td>
                    <td><%= link_to "View", party_screening_path(s), class: "btn btn-ghost btn-xs" %></td>
                  </tr>
                <% end %>
                <% if @party.screenings.empty? %>
                  <tr><td colspan="5" class="opacity-60 text-center py-4">No screenings yet.</td></tr>
                <% end %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </section>
  </div>
</div>
<!-- app/views/party/parties/show.html.erb (bottom of page) -->
<div data-controller="modal" data-modal-id-value="comm-modal">
  <%= render "shared/modal", id: "comm-modal" do %>
    <turbo-frame id="comm_modal_frame"
      data-action="turbo:frame-load->modal#open turbo:submit-end->modal#maybeClose">
    </turbo-frame>
  <% end %>
</div>