<%# app/views/party/parties/show.html.erb %>

<%# ---- Modal host for Turbo-loaded forms ---- %>
<div data-controller="modal" data-modal-id-value="comm-modal">
  <%= render "shared/modal" %>
</div>

<%# ===== Page header ===== %>
<div class="flex items-center justify-between mb-6">
  <div>
    <h1 class="text-2xl md:text-3xl font-semibold"><%= @party.display_name %></h1>
    <div class="mt-2 flex flex-wrap gap-2 text-sm">
      <span class="badge badge-outline"><%= @party.party_type %></span>
      <% if @party.customer_number.present? %>
        <span class="badge badge-outline">Customer # <%= @party.customer_number %></span>
        <button
          class="btn btn-ghost btn-xs focus-visible:outline focus-visible:outline-2"
          data-controller="copy"
          data-copy-text-value="<%= @party.customer_number %>"
          data-action="copy#copy"
          aria-label="Copy customer number">Copy</button>
      <% end %>
      <span class="badge badge-ghost">Updated <%= l(@party.updated_at, format: :short) %></span>
    </div>
  </div>
  <div class="flex gap-2">
    <%= link_to "Edit", edit_party_party_path(@party), class: "btn btn-ghost btn-sm" %>
    <button class="btn btn-error btn-soft btn-sm"
            onclick="document.getElementById('confirm-delete').showModal()"
            aria-label="Delete party">Delete</button>
    <%= link_to "Back", party_parties_path, class: "btn btn-ghost btn-sm" %>
  </div>
</div>

<%# ===== Two-column layout ===== %>
<div class="grid md:grid-cols-2 gap-4">
  <%# --- Left: Identity --- %>
  <div class="card bg-base-100 shadow">
    <div class="card-body">
      <h2 class="card-title text-base">Identity</h2>
      <dl class="divide-y divide-base-200">
        <% if @party.person %>
          <div class="py-2 grid grid-cols-3 gap-2">
            <dt class="opacity-70">Name</dt>
            <dd class="col-span-2">
              <%= [@party.person.first_name, @party.person.middle_name, @party.person.last_name, @party.person.name_suffix].compact_blank.join(" ") %>
            </dd>
          </div>
          <% if @party.person.courtesy_title.present? %>
            <div class="py-2 grid grid-cols-3 gap-2">
              <dt class="opacity-70">Title</dt>
              <dd class="col-span-2"><%= @party.person.courtesy_title %></dd>
            </div>
          <% end %>
          <% if @party.person.date_of_birth.present? %>
            <div class="py-2 grid grid-cols-3 gap-2">
              <dt class="opacity-70">DOB</dt>
              <dd class="col-span-2"><%= @party.person.date_of_birth.to_fs(:mmm_d_yyyy) %></dd>
            </div>
          <% end %>
        <% elsif @party.organization %>
          <div class="py-2 grid grid-cols-3 gap-2">
            <dt class="opacity-70">Legal name</dt>
            <dd class="col-span-2"><%= @party.organization.legal_name %></dd>
          </div>
          <% if @party.organization.operating_name.present? %>
            <div class="py-2 grid grid-cols-3 gap-2">
              <dt class="opacity-70">DBA</dt>
              <dd class="col-span-2"><%= @party.organization.operating_name %></dd>
            </div>
          <% end %>
          <% if @party.organization.organization_type_code.present? %>
            <div class="py-2 grid grid-cols-3 gap-2">
              <dt class="opacity-70">Type</dt>
              <dd class="col-span-2">
                <span class="badge badge-outline"><%= @party.organization.organization_type_code %></span>
              </dd>
            </div>
          <% end %>
          <% if @party.organization.formation_date.present? %>
            <div class="py-2 grid grid-cols-3 gap-2">
              <dt class="opacity-70">Formed</dt>
              <dd class="col-span-2"><%= @party.organization.formation_date.to_fs(:mmm_d_yyyy) %></dd>
            </div>
          <% end %>
        <% else %>
          <div class="py-2 text-sm opacity-70">No identity details</div>
        <% end %>
      </dl>

      <%= render "party/identifiers/list", party: @party %>
    </div>
  </div>

  <%# --- Right: Communications --- %>
  <div class="flex flex-col gap-6">
    <%= render "party/addresses/list", party: @party %>
    <%= render "party/phones/list",    party: @party %>
    <%= render "party/emails/list",    party: @party %>
  </div>
</div>

<%# ===== Relationships & Groups ===== %>
<div class="grid md:grid-cols-2 gap-4 mt-6">
  <%# --- Relationships (partyâ†”party) --- %>
  <div class="card bg-base-100 shadow">
    <div class="card-body">
      <h2 class="card-title text-base">Relationships</h2>

      <div id="links_by_type">
        <%= render "party/links/list_by_type",
              party: @party,
              links: @party.links.involving(@party.id).order(:party_link_type_code),
              editable: true %>
      </div>

      <turbo-frame id="comm_modal_frame">
        <%= render "party/links/form",
              party: @party,
              link_types: Ref::PartyLinkType.order(:name) %>
      </turbo-frame>
    </div>
  </div>

  <%# --- Groups (household example) --- %>
  <%= render "party/groups/section", party: @party %>
</div>

<%# ===== Screenings ===== %>
<div class="card my-4 p-4">
  <div class="flex items-center justify-between">
    <h2 class="text-xl font-semibold">Screenings</h2>
    <div class="flex items-center gap-2">
      <% if @party.party_risk_score %>
        <% badge = { 0 => "badge-success", 1 => "badge-warning", 2 => "badge-error" }[@party.risk_band] %>
        <span class="badge <%= badge %>">Risk <%= @party.party_risk_score %></span>
      <% end %>
      <%= link_to "New screening",
          new_party_party_screening_path(@party.public_id),
          class: "btn btn-primary btn-sm" %>
    </div>
  </div>

  <table class="table mt-3">
    <thead>
      <tr><th>When</th><th>Kind</th><th>Status</th><th>Score</th><th>Norm</th><th></th></tr>
    </thead>
    <tbody>
      <% @party.screenings.order(created_at: :desc).limit(5).each do |s| %>
        <tr>
          <td><%= s.completed_at&.to_fs(:long) || s.requested_at&.to_fs(:long) %></td>
          <td><%= s.kind.humanize %></td>
          <td><span class="badge"><%= s.status.humanize %></span></td>
          <td><%= s.vendor_score %></td>
          <td><%= s.normalized_score %></td>
          <td><%= link_to "View", party_screening_path(s), class: "btn btn-ghost btn-xs" %></td>
        </tr>
      <% end %>
      <% if @party.screenings.empty? %>
        <tr><td colspan="6" class="opacity-60">No screenings yet.</td></tr>
      <% end %>
    </tbody>
  </table>
</div>
