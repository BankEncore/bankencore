<!DOCTYPE html>
<html lang="en" data-theme="blueLight">
  <head>
    <title><%= content_for?(:title) ? yield(:title) : "BankEncoRRe" %></title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>
    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>
    <script>
    (function(){
      const KEY="daisy-theme", root=document.documentElement;
      const saved=localStorage.getItem(KEY);
      if(saved) root.setAttribute("data-theme",saved);

      document.addEventListener("change", e=>{
        const t=e.target;
        if(t?.classList?.contains("theme-controller")){
          root.setAttribute("data-theme",t.value);
          try{ localStorage.setItem(KEY,t.value); }catch(_){}
        }
      });

      const syncUI=()=>{
        const current=root.getAttribute("data-theme")||"blueLight";
        document.querySelectorAll(".theme-controller").forEach(el=>{ el.checked=(el.value===current); });

        const sel=document.getElementById("party-search-type");
        const q  =document.getElementById("party-search-q");
        const eye=document.getElementById("party-search-reveal");
        if(!sel||!q) return;

        // remember previous mode
        q.dataset.prevMode = q.dataset.prevMode || sel.value;

        const setSearchUI=()=>{
          const tax = sel.value==="tax_id";

          // CLEAR when switching modes
          if(q.dataset.prevMode !== sel.value){ q.value=""; }
          q.dataset.prevMode = sel.value;

          q.type        = tax ? "password" : "text";
          q.placeholder = tax ? "Search by tax ID" : "Search by name or customer #";
          q.inputMode   = tax ? "numeric" : "text";
          q.removeAttribute("pattern");

          if(eye){
            eye.classList.toggle("hidden", !tax);
            eye.setAttribute("aria-label", q.type==="password" ? "Show tax ID" : "Hide tax ID");
          }
        };

        sel.removeEventListener("change", setSearchUI);
        sel.addEventListener("change", setSearchUI);

        if(eye){
          const toggle=()=>{
            if(q.type==="password"){ q.type="text";  eye.setAttribute("aria-label","Hide tax ID"); }
            else                   { q.type="password"; eye.setAttribute("aria-label","Show tax ID"); }
            q.focus();
          };
          eye.removeEventListener("click", toggle);
          eye.addEventListener("click", toggle);
        }

        setSearchUI();
      };

      document.addEventListener("turbo:load",   syncUI);
      document.addEventListener("turbo:render", syncUI);
    })();
    </script>
    <!-- SVG (preferred) -->
    <link rel="icon" type="image/svg+xml" href="<%= asset_path('favicon.svg') %>">

    <!-- PNG fallbacks -->
    <link rel="icon" sizes="32x32"  type="image/png" href="<%= asset_path('favicon-32.png') %>">
    <link rel="icon" sizes="192x192" type="image/png" href="<%= asset_path('favicon-192.png') %>">
    <link rel="icon" sizes="512x512" type="image/png" href="<%= asset_path('favicon-512.png') %>">

    <!-- iOS/Android home screen -->
    <link rel="apple-touch-icon" sizes="180x180" href="<%= asset_path('favicon-180.png') %>">

    <!-- Safari pinned tab (optional) -->
    <link rel="mask-icon" href="<%= asset_path('mask-icon.svg') %>" color="#8E3B3B">

    <!-- Address bar color (optional) -->
    <meta name="theme-color" content="#F9F5F0">
  </head>

  <body class="min-h-screen">
    <header class="bg-base-100 border-b">
      <div class="max-w-7xl mx-auto flex flex-row flex-wrap md:flex-nowrap items-center justify-between gap-3 px-4 md:px-6 py-3">

        <!-- left -->
        <%= link_to root_path, class: "flex items-center gap-2 shrink-0" do %>
          <%= render "shared/logo" %>
        <% end %>

        <!-- center -->
        <nav class="hidden md:flex flex-1 justify-center items-center gap-2" role="navigation" aria-label="Main">
          <%= link_to "Home", root_path, class: "btn btn-ghost btn-sm" %>
          <%= link_to "Parties", party_parties_path, class: "btn btn-ghost btn-sm" %>
          <%= link_to "Cases", "#", class: "btn btn-ghost btn-sm" %>
          <%= link_to "Reports", "#", class: "btn btn-ghost btn-sm" %>
        </nav>

        <!-- right -->
        <div class="flex items-center gap-3 shrink-0">
          <%= form_with url: party_parties_path, method: :get, local: true, class: "join hidden md:flex" do %>
            <%= select_tag :search_type,
                  options_for_select([["ID/Name","id_name"],["Tax ID","tax_id"]], params[:search_type].presence || "id_name"),
                  id: "party-search-type",
                  class: "select select-bordered select-sm join-item" %>

            <div class="join">
              <%= text_field_tag :q, params[:q],
                    id: "party-search-q",
                    aria: { label: "Search parties" },
                    class: "input input-bordered input-sm join-item w-64 md:w-80",
                    placeholder: "Search by name or customer #" %>
              <button id="party-search-reveal" type="button" class="btn btn-sm join-item hidden" aria-label="Show tax ID">üëÅ</button>
            </div>

            <button class="btn btn-sm join-item" type="submit">Search</button>
          <% end %>

          <%= link_to "New Party", new_party_party_path, class: "btn btn-primary btn-sm hidden md:inline-flex" %>
          <%= render "shared/user_menu" %>
        </div> <!-- right -->

      </div> <!-- header container -->
    </header>

    <main class="max-w-7xl mx-auto px-4 md:px-6 py-6">
      <% flash.each do |type, msg| %>
        <% tone = { notice: "info", alert: "warning", error: "error", success: "success" }[type.to_sym] || "info" %>
        <div class="alert alert-<%= tone %> mb-3"><%= msg %></div>
      <% end %>
      <%= yield %>
    </main>

    <footer class="border-t">
      <div class="max-w-7xl mx-auto p-4 text-sm opacity-70 flex items-center justify-between">
        <div>
          ¬© <%= Time.current.year %> YourApp ¬∑ <a href="#" class="link">Privacy</a>
        </div>

        <div>
          <% if respond_to?(:authenticated?) && authenticated? %>
            <span class="inline-flex items-center gap-2">
              <span class="w-6 h-6 rounded-full bg-base-300 grid place-items-center">
                <svg class="w-4 h-4" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 14c-3.9 0-7 1.8-7 4v1h14v-1c0-2.2-3.1-4-7-4Zm0-2a4 4 0 1 0 0-8 4 4 0 0 0 0 8Z"/></svg>
              </span>
              <%= (Current.user&.display_name || Current.user&.email_address || Current.user&.email) %>
            </span>
          <% else %>
            <%= link_to "Sign in", sign_in_path, class: "link" %>
          <% end %>
        </div>
      </div>
  </footer>

    <turbo-frame id="comm_modal_frame"></turbo-frame>
  </body>
</html>
